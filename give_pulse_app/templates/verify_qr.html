{% extends "base.html" %}
{% load static %}

{% block title %}Verify QR Code - GivePulse{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-qr-code-scan"></i> QR Code Verification
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <h6><i class="bi bi-info-circle"></i> QR Code Verification</h6>
                        <p class="mb-0">Scan or enter a <strong>GivePulse appointment QR code</strong> to verify and complete a donation.</p>
                        <hr class="my-2">
                        <small class="text-muted">
                            <strong>Note:</strong> Only QR codes generated by GivePulse appointment system will work. 
                            Other QR codes (product codes, URLs, etc.) will be rejected.
                        </small>
                    </div>
                    
                    {% if is_valid is None %}
                        <!-- QR Code Scanner -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">
                                    <i class="bi bi-camera"></i> QR Code Scanner
                                </h6>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="toggleCamera">
                                    <i class="bi bi-camera-video"></i> <span id="cameraToggleText">Start Camera</span>
                                </button>
                            </div>
                            
                            <!-- Camera Video Element -->
                            <div id="cameraContainer" class="text-center mb-3" style="display: none;">
                                <div class="position-relative d-inline-block">
                                    <video id="video" width="100%" height="300" style="border-radius: 8px; background: #f8f9fa;"></video>
                                    <!-- Scanning overlay -->
                                    <div id="scanOverlay" class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="pointer-events: none;">
                                        <div class="scan-frame" style="
                                            width: 200px; 
                                            height: 200px; 
                                            border: 2px solid #007bff; 
                                            border-radius: 8px;
                                            position: relative;
                                            animation: scanPulse 2s infinite;
                                        ">
                                            <div class="scan-corner" style="
                                                position: absolute;
                                                top: -2px;
                                                left: -2px;
                                                width: 20px;
                                                height: 20px;
                                                border-top: 4px solid #28a745;
                                                border-left: 4px solid #28a745;
                                            "></div>
                                            <div class="scan-corner" style="
                                                position: absolute;
                                                top: -2px;
                                                right: -2px;
                                                width: 20px;
                                                height: 20px;
                                                border-top: 4px solid #28a745;
                                                border-right: 4px solid #28a745;
                                            "></div>
                                            <div class="scan-corner" style="
                                                position: absolute;
                                                bottom: -2px;
                                                left: -2px;
                                                width: 20px;
                                                height: 20px;
                                                border-bottom: 4px solid #28a745;
                                                border-left: 4px solid #28a745;
                                            "></div>
                                            <div class="scan-corner" style="
                                                position: absolute;
                                                bottom: -2px;
                                                right: -2px;
                                                width: 20px;
                                                height: 20px;
                                                border-bottom: 4px solid #28a745;
                                                border-right: 4px solid #28a745;
                                            "></div>
                                        </div>
                                    </div>
                                </div>
                <div class="mt-2">
                    <small class="text-muted">Position the <strong>appointment QR code</strong> within the scanning frame</small>
                    <br>
                    <small class="text-info">
                        <i class="bi bi-info-circle"></i> Only scans GivePulse appointment QR codes
                    </small>
                </div>
                                <div id="scanStatus" class="mt-1">
                                    <small class="text-info">
                                        <i class="bi bi-search"></i> Scanning for QR codes...
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Input Options -->
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#manualInput">
                                    <i class="bi bi-keyboard"></i> Manual Input
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm ms-2" id="restartCamera" style="display: none;">
                                    <i class="bi bi-camera-video"></i> Scan Again
                                </button>
                            </div>
                            
                            <div class="collapse" id="manualInput">
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="qr_data" class="form-label fw-semibold">
                                            <i class="bi bi-qr-code"></i> QR Code Data
                                        </label>
                                        <textarea 
                                            class="form-control" 
                                            id="qr_data" 
                                            name="qr_data" 
                                            rows="4" 
                                            placeholder="Paste QR code data here..."
                                        ></textarea>
                                        <div class="form-text">
                                            Manually enter the QR code data if camera scanning is not available.
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-search"></i> Verify QR Code
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% elif is_valid %}
                        <!-- Valid QR Code Display -->
                        <div class="alert alert-success">
                            <h5><i class="bi bi-check-circle"></i> Valid QR Code</h5>
                            <p class="mb-0">Appointment details verified successfully.</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Donor Information</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Name:</strong> {{ qr_data.donor_name }}</li>
                                    <li><strong>Blood Type:</strong> {{ qr_data.blood_type }}</li>
                                    <li><strong>Donor ID:</strong> {{ qr_data.donor_id }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Appointment Details</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Hospital:</strong> {{ qr_data.hospital }}</li>
                                    <li><strong>Date:</strong> {{ appointment.window_start|date:"M d, Y H:i" }}</li>
                                    <li><strong>Window:</strong> {{ appointment.window_start|date:"H:i" }} - {{ appointment.window_end|date:"H:i" }}</li>
                                    <li><strong>Verification Code:</strong> {{ qr_data.verification_code }}</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6 class="text-primary">QR Code Image</h6>
                            {% if appointment.qr_code_image %}
                                <img src="{{ appointment.qr_code_image.url }}" alt="QR Code" class="img-fluid" style="max-width: 200px;">
                            {% endif %}
                        </div>
                        
                        <div class="mt-4 d-grid gap-2 d-md-flex justify-content-md-center">
                            {% if user.staff %}
                                <a href="{% url 'complete_donation' appointment.id %}" class="btn btn-success">
                                    <i class="bi bi-check-circle"></i> Complete Donation
                                </a>
                            {% endif %}
                            <a href="{% url 'verify_qr' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Verify Another QR Code
                            </a>
                        </div>
                    {% else %}
                        <!-- Invalid QR Code -->
                        <div class="alert alert-danger">
                            <h5><i class="bi bi-x-circle"></i> Invalid QR Code</h5>
                            <p class="mb-0">The QR code data is invalid or corrupted. Please try again.</p>
                        </div>
                        
                        <div class="d-grid">
                            <a href="{% url 'verify_qr' %}" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-left"></i> Try Again
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Scanner CSS -->
<style>
@keyframes scanPulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.scan-frame {
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
}

#scanStatus.success {
    color: #28a745 !important;
}

#scanStatus.error {
    color: #dc3545 !important;
}
</style>

<!-- QR Code Scanner JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('video');
    const cameraContainer = document.getElementById('cameraContainer');
    const toggleButton = document.getElementById('toggleCamera');
    const toggleText = document.getElementById('cameraToggleText');
    const scanStatus = document.getElementById('scanStatus');
    let stream = null;
    let scanning = false;
    let scanInterval = null;

    // Toggle camera function
    toggleButton.addEventListener('click', function() {
        if (scanning) {
            stopCamera();
        } else {
            startCamera();
        }
    });

    async function startCamera() {
        try {
            // Request camera access
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment', // Use back camera if available
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } 
            });
            
            video.srcObject = stream;
            video.play();
            cameraContainer.style.display = 'block';
            scanning = true;
            
            toggleText.textContent = 'Stop Camera';
            toggleButton.innerHTML = '<i class="bi bi-camera-video-off"></i> Stop Camera';
            toggleButton.classList.remove('btn-outline-primary');
            toggleButton.classList.add('btn-outline-danger');
            
            // Start scanning for QR codes
            startScanning();
            
        } catch (error) {
            console.error('Error accessing camera:', error);
            scanStatus.innerHTML = '<small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Unable to access camera. Please use manual input.</small>';
            scanStatus.className = 'mt-1 error';
            
            // Show manual input section
            const manualInput = document.getElementById('manualInput');
            if (manualInput) {
                manualInput.classList.add('show');
            }
        }
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        
        if (scanInterval) {
            clearInterval(scanInterval);
            scanInterval = null;
        }
        
        cameraContainer.style.display = 'none';
        scanning = false;
        
        // Show restart button
        const restartBtn = document.getElementById('restartCamera');
        if (restartBtn) {
            restartBtn.style.display = 'inline-block';
        }
        
        toggleText.textContent = 'Start Camera';
        toggleButton.innerHTML = '<i class="bi bi-camera-video"></i> Start Camera';
        toggleButton.classList.remove('btn-outline-danger');
        toggleButton.classList.add('btn-outline-primary');
    }

    function startScanning() {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        scanInterval = setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                        if (code) {
                            console.log('QR Code detected:', code.data);
                            
                            // Validate QR code format before processing
                            const qrData = code.data.trim();
                            
                            // Check if it looks like our appointment QR code
                                if (qrData.startsWith('{') && qrData.includes('appointment_id')) {
                                    try {
                                        // Try to parse JSON to validate format
                                        const parsed = JSON.parse(qrData);
                                        if (parsed.appointment_id && parsed.match_id) {
                                            // Valid appointment QR code - paste into manual input field
                                            scanStatus.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Valid appointment QR detected! Data copied to manual input.</small>';
                                            scanStatus.className = 'mt-1 success';
                                            
                                            // Stop scanning
                                            stopCamera();
                                            
                                            // Paste QR data into manual input field
                                            const manualInput = document.getElementById('qr_data');
                                            if (manualInput) {
                                                manualInput.value = qrData;
                                                
                                                // Show the manual input section
                                                const manualInputCollapse = document.getElementById('manualInput');
                                                if (manualInputCollapse) {
                                                    manualInputCollapse.classList.add('show');
                                                }
                                                
                                                // Scroll to the manual input section
                                                manualInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                                
                                                // Focus on the input field
                                                manualInput.focus();
                                                
                                                // Show success message
                                                scanStatus.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> QR data copied to manual input field below. Review and click "Verify QR Code" to proceed.</small>';
                                            }
                                        } else {
                                            // Invalid appointment QR format
                                            scanStatus.innerHTML = '<small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Invalid appointment QR format</small>';
                                            scanStatus.className = 'mt-1 error';
                                            setTimeout(() => {
                                                scanStatus.innerHTML = '<small class="text-info"><i class="bi bi-search"></i> Scanning for QR codes...</small>';
                                                scanStatus.className = 'mt-1';
                                            }, 2000);
                                        }
                                    } catch (e) {
                                        // Invalid JSON
                                        scanStatus.innerHTML = '<small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Invalid QR code format</small>';
                                        scanStatus.className = 'mt-1 error';
                                        setTimeout(() => {
                                            scanStatus.innerHTML = '<small class="text-info"><i class="bi bi-search"></i> Scanning for QR codes...</small>';
                                            scanStatus.className = 'mt-1';
                                        }, 2000);
                                    }
                                } else {
                                    // Not an appointment QR code
                                    scanStatus.innerHTML = '<small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Not an appointment QR code</small>';
                                    scanStatus.className = 'mt-1 error';
                                    setTimeout(() => {
                                        scanStatus.innerHTML = '<small class="text-info"><i class="bi bi-search"></i> Scanning for QR codes...</small>';
                                        scanStatus.className = 'mt-1';
                                    }, 2000);
                                }
                        }
            }
        }, 100); // Check every 100ms
    }


    // Restart camera functionality
    const restartCameraBtn = document.getElementById('restartCamera');
    if (restartCameraBtn) {
        restartCameraBtn.addEventListener('click', function() {
            // Clear the manual input field
            const manualInput = document.getElementById('qr_data');
            if (manualInput) {
                manualInput.value = '';
            }
            
            // Hide the manual input section
            const manualInputCollapse = document.getElementById('manualInput');
            if (manualInputCollapse) {
                manualInputCollapse.classList.remove('show');
            }
            
            // Hide the restart button
            restartCameraBtn.style.display = 'none';
            
            // Start camera again
            startCamera();
        });
    }


    // Clean up when page is unloaded
    window.addEventListener('beforeunload', function() {
        stopCamera();
    });
});
</script>
{% endblock %}
